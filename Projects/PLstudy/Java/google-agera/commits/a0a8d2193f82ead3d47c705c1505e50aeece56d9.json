{"sha":"a0a8d2193f82ead3d47c705c1505e50aeece56d9","commit":{"author":{"name":"Magnus Ernstsson","email":"magnus@ernstsson.net","date":"2016-05-03T07:22:23Z"},"committer":{"name":"Magnus Ernstsson","email":"magnus@ernstsson.net","date":"2016-05-03T07:26:55Z"},"message":"Pulled Common.WorkerHandler to package level\n\nFixes #41","tree":{"sha":"9338026cde1a8375086c7570c2e3777916740bbe","url":"https://api.github.com/repos/google/agera/git/trees/9338026cde1a8375086c7570c2e3777916740bbe"},"url":"https://api.github.com/repos/google/agera/git/commits/a0a8d2193f82ead3d47c705c1505e50aeece56d9","comment_count":0},"url":"https://api.github.com/repos/google/agera/commits/a0a8d2193f82ead3d47c705c1505e50aeece56d9","html_url":"https://github.com/google/agera/commit/a0a8d2193f82ead3d47c705c1505e50aeece56d9","comments_url":"https://api.github.com/repos/google/agera/commits/a0a8d2193f82ead3d47c705c1505e50aeece56d9/comments","author":{"login":"ernstsson","id":378389,"avatar_url":"https://avatars2.githubusercontent.com/u/378389?v=3","gravatar_id":"","url":"https://api.github.com/users/ernstsson","html_url":"https://github.com/ernstsson","followers_url":"https://api.github.com/users/ernstsson/followers","following_url":"https://api.github.com/users/ernstsson/following{/other_user}","gists_url":"https://api.github.com/users/ernstsson/gists{/gist_id}","starred_url":"https://api.github.com/users/ernstsson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ernstsson/subscriptions","organizations_url":"https://api.github.com/users/ernstsson/orgs","repos_url":"https://api.github.com/users/ernstsson/repos","events_url":"https://api.github.com/users/ernstsson/events{/privacy}","received_events_url":"https://api.github.com/users/ernstsson/received_events","type":"User","site_admin":false},"committer":{"login":"ernstsson","id":378389,"avatar_url":"https://avatars2.githubusercontent.com/u/378389?v=3","gravatar_id":"","url":"https://api.github.com/users/ernstsson","html_url":"https://github.com/ernstsson","followers_url":"https://api.github.com/users/ernstsson/followers","following_url":"https://api.github.com/users/ernstsson/following{/other_user}","gists_url":"https://api.github.com/users/ernstsson/gists{/gist_id}","starred_url":"https://api.github.com/users/ernstsson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ernstsson/subscriptions","organizations_url":"https://api.github.com/users/ernstsson/orgs","repos_url":"https://api.github.com/users/ernstsson/repos","events_url":"https://api.github.com/users/ernstsson/events{/privacy}","received_events_url":"https://api.github.com/users/ernstsson/received_events","type":"User","site_admin":false},"parents":[{"sha":"78326e2de34e238bfa12ccc66f32f0555597ab29","url":"https://api.github.com/repos/google/agera/commits/78326e2de34e238bfa12ccc66f32f0555597ab29","html_url":"https://github.com/google/agera/commit/78326e2de34e238bfa12ccc66f32f0555597ab29"}],"stats":{"total":143,"additions":69,"deletions":74},"files":[{"sha":"20025461281335d8fa5fd354df737056f2a58948","filename":"agera/src/main/java/com/google/android/agera/BaseObservable.java","status":"modified","additions":3,"deletions":5,"changes":8,"blob_url":"https://github.com/google/agera/blob/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/BaseObservable.java","raw_url":"https://github.com/google/agera/raw/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/BaseObservable.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/BaseObservable.java?ref=a0a8d2193f82ead3d47c705c1505e50aeece56d9","patch":"@@ -15,13 +15,11 @@\n  */\n package com.google.android.agera;\n \n-import static com.google.android.agera.Common.WorkerHandler.MSG_LAST_REMOVED;\n-import static com.google.android.agera.Common.WorkerHandler.MSG_UPDATE;\n-import static com.google.android.agera.Common.workerHandler;\n+import static com.google.android.agera.WorkerHandler.MSG_LAST_REMOVED;\n+import static com.google.android.agera.WorkerHandler.MSG_UPDATE;\n+import static com.google.android.agera.WorkerHandler.workerHandler;\n import static com.google.android.agera.Preconditions.checkState;\n \n-import com.google.android.agera.Common.WorkerHandler;\n-\n import android.os.Handler;\n import android.os.Looper;\n import android.support.annotation.NonNull;"},{"sha":"bcdcda08c226512ff3d100301449ebcae203d97b","filename":"agera/src/main/java/com/google/android/agera/Common.java","status":"modified","additions":0,"deletions":61,"changes":61,"blob_url":"https://github.com/google/agera/blob/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/Common.java","raw_url":"https://github.com/google/agera/raw/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/Common.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/Common.java?ref=a0a8d2193f82ead3d47c705c1505e50aeece56d9","patch":"@@ -18,34 +18,14 @@\n import static com.google.android.agera.Preconditions.checkNotNull;\n import static com.google.android.agera.Result.failure;\n \n-import com.google.android.agera.BaseObservable.Worker;\n-import com.google.android.agera.Observables.LowPassFilterObservable;\n-\n-import android.os.Handler;\n-import android.os.Message;\n import android.support.annotation.NonNull;\n \n-import java.lang.ref.WeakReference;\n-\n final class Common {\n   static final Function<Throwable, ? extends Result<?>> FAILED_RESULT = new FailedResult<>();\n   static final Function IDENTITY_FUNCTION = new IdentityFunction();\n   static final StaticCondicate TRUE_CONDICATE = new StaticCondicate(true);\n   static final StaticCondicate FALSE_CONDICATE = new StaticCondicate(false);\n \n-  private static final ThreadLocal<WeakReference<WorkerHandler>> handlers = new ThreadLocal<>();\n-\n-  @NonNull\n-  static WorkerHandler workerHandler() {\n-    final WeakReference<WorkerHandler> handlerReference = handlers.get();\n-    WorkerHandler handler = handlerReference != null ? handlerReference.get() : null;\n-    if (handler == null) {\n-      handler = new WorkerHandler();\n-      handlers.set(new WeakReference<>(handler));\n-    }\n-    return handler;\n-  }\n-\n   private static final class IdentityFunction implements Function {\n     @NonNull\n     @Override\n@@ -100,47 +80,6 @@ public TTo get() {\n     }\n   }\n \n-  /**\n-   * Shared per-thread worker Handler behind internal logic of various Agera classes.\n-   */\n-  static final class WorkerHandler extends Handler {\n-    static final int MSG_FIRST_ADDED = 0;\n-    static final int MSG_LAST_REMOVED = 1;\n-    static final int MSG_UPDATE = 2;\n-    static final int MSG_CALL_UPDATABLE = 3;\n-    static final int MSG_CALL_MAYBE_START_FLOW = 4;\n-    static final int MSG_CALL_ACKNOWLEDGE_CANCEL = 5;\n-    static final int MSG_CALL_LOW_PASS_UPDATE = 6;\n-\n-    @Override\n-    public void handleMessage(final Message message) {\n-      switch (message.what) {\n-        case MSG_UPDATE:\n-          ((Worker) message.obj).sendUpdate();\n-          break;\n-        case MSG_FIRST_ADDED:\n-          ((Worker) message.obj).callFirstUpdatableAdded();\n-          break;\n-        case MSG_LAST_REMOVED:\n-          ((Worker) message.obj).callLastUpdatableRemoved();\n-          break;\n-        case MSG_CALL_UPDATABLE:\n-          ((Updatable) message.obj).update();\n-          break;\n-        case MSG_CALL_MAYBE_START_FLOW:\n-          ((CompiledRepository) message.obj).maybeStartFlow();\n-          break;\n-        case MSG_CALL_ACKNOWLEDGE_CANCEL:\n-          ((CompiledRepository) message.obj).acknowledgeCancel();\n-          break;\n-        case MSG_CALL_LOW_PASS_UPDATE:\n-          ((LowPassFilterObservable) message.obj).lowPassUpdate();\n-          break;\n-        default:\n-      }\n-    }\n-  }\n-\n   private static final class FailedResult<T> implements Function<Throwable, Result<T>> {\n     @NonNull\n     @Override"},{"sha":"a3028a056efccacd268ad1039d649decae4d305e","filename":"agera/src/main/java/com/google/android/agera/CompiledRepository.java","status":"modified","additions":3,"deletions":5,"changes":8,"blob_url":"https://github.com/google/agera/blob/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/CompiledRepository.java","raw_url":"https://github.com/google/agera/raw/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/CompiledRepository.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/CompiledRepository.java?ref=a0a8d2193f82ead3d47c705c1505e50aeece56d9","patch":"@@ -15,9 +15,9 @@\n  */\n package com.google.android.agera;\n \n-import static com.google.android.agera.Common.WorkerHandler.MSG_CALL_ACKNOWLEDGE_CANCEL;\n-import static com.google.android.agera.Common.WorkerHandler.MSG_CALL_MAYBE_START_FLOW;\n-import static com.google.android.agera.Common.workerHandler;\n+import static com.google.android.agera.WorkerHandler.MSG_CALL_ACKNOWLEDGE_CANCEL;\n+import static com.google.android.agera.WorkerHandler.MSG_CALL_MAYBE_START_FLOW;\n+import static com.google.android.agera.WorkerHandler.workerHandler;\n import static com.google.android.agera.Observables.compositeObservable;\n import static com.google.android.agera.Observables.perMillisecondObservable;\n import static com.google.android.agera.Preconditions.checkNotNull;\n@@ -27,8 +27,6 @@\n import static com.google.android.agera.RepositoryConfig.SEND_INTERRUPT;\n import static java.lang.Thread.currentThread;\n \n-import com.google.android.agera.Common.WorkerHandler;\n-\n import android.support.annotation.IntDef;\n import android.support.annotation.NonNull;\n import android.support.annotation.Nullable;"},{"sha":"569e98c8036d426a1a4d8cf936ad93536def1df7","filename":"agera/src/main/java/com/google/android/agera/Observables.java","status":"modified","additions":1,"deletions":3,"changes":4,"blob_url":"https://github.com/google/agera/blob/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/Observables.java","raw_url":"https://github.com/google/agera/raw/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/Observables.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/Observables.java?ref=a0a8d2193f82ead3d47c705c1505e50aeece56d9","patch":"@@ -15,11 +15,9 @@\n  */\n package com.google.android.agera;\n \n-import static com.google.android.agera.Common.workerHandler;\n+import static com.google.android.agera.WorkerHandler.workerHandler;\n import static com.google.android.agera.Preconditions.checkNotNull;\n \n-import com.google.android.agera.Common.WorkerHandler;\n-\n import android.os.Looper;\n import android.os.SystemClock;\n import android.support.annotation.NonNull;"},{"sha":"98ba4bbe1ec0335adf197408478158b76b724aeb","filename":"agera/src/main/java/com/google/android/agera/WorkerHandler.java","status":"added","additions":62,"deletions":0,"changes":62,"blob_url":"https://github.com/google/agera/blob/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/WorkerHandler.java","raw_url":"https://github.com/google/agera/raw/a0a8d2193f82ead3d47c705c1505e50aeece56d9/agera/src/main/java/com/google/android/agera/WorkerHandler.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/WorkerHandler.java?ref=a0a8d2193f82ead3d47c705c1505e50aeece56d9","patch":"@@ -0,0 +1,62 @@\n+package com.google.android.agera;\n+\n+import android.os.Handler;\n+import android.os.Message;\n+import android.support.annotation.NonNull;\n+\n+import java.lang.ref.WeakReference;\n+\n+/**\n+ * Shared per-thread worker Handler behind internal logic of various Agera classes.\n+ */\n+final class WorkerHandler extends Handler {\n+  static final int MSG_FIRST_ADDED = 0;\n+  static final int MSG_LAST_REMOVED = 1;\n+  static final int MSG_UPDATE = 2;\n+  static final int MSG_CALL_UPDATABLE = 3;\n+  static final int MSG_CALL_MAYBE_START_FLOW = 4;\n+  static final int MSG_CALL_ACKNOWLEDGE_CANCEL = 5;\n+  static final int MSG_CALL_LOW_PASS_UPDATE = 6;\n+  private static final ThreadLocal<WeakReference<WorkerHandler>> handlers = new ThreadLocal<>();\n+\n+  @NonNull\n+  static WorkerHandler workerHandler() {\n+    final WeakReference<WorkerHandler> handlerReference = handlers.get();\n+    WorkerHandler handler = handlerReference != null ? handlerReference.get() : null;\n+    if (handler == null) {\n+      handler = new WorkerHandler();\n+      handlers.set(new WeakReference<>(handler));\n+    }\n+    return handler;\n+  }\n+\n+  private WorkerHandler() {}\n+\n+  @Override\n+  public void handleMessage(final Message message) {\n+    switch (message.what) {\n+      case MSG_UPDATE:\n+        ((BaseObservable.Worker) message.obj).sendUpdate();\n+        break;\n+      case MSG_FIRST_ADDED:\n+        ((BaseObservable.Worker) message.obj).callFirstUpdatableAdded();\n+        break;\n+      case MSG_LAST_REMOVED:\n+        ((BaseObservable.Worker) message.obj).callLastUpdatableRemoved();\n+        break;\n+      case MSG_CALL_UPDATABLE:\n+        ((Updatable) message.obj).update();\n+        break;\n+      case MSG_CALL_MAYBE_START_FLOW:\n+        ((CompiledRepository) message.obj).maybeStartFlow();\n+        break;\n+      case MSG_CALL_ACKNOWLEDGE_CANCEL:\n+        ((CompiledRepository) message.obj).acknowledgeCancel();\n+        break;\n+      case MSG_CALL_LOW_PASS_UPDATE:\n+        ((Observables.LowPassFilterObservable) message.obj).lowPassUpdate();\n+        break;\n+      default:\n+    }\n+  }\n+}"}]}