{"sha":"f7b24a991a740cd4cefae388838ac38809897fae","commit":{"author":{"name":"Magnus Ernstsson","email":"magnus@ernstsson.net","date":"2016-08-16T04:04:50Z"},"committer":{"name":"GitHub","email":"noreply@github.com","date":"2016-08-16T04:04:50Z"},"message":"Reused function compiler instance per thread (#100)","tree":{"sha":"55aaf29414bffa4bfb365bc146be888ff60fb73c","url":"https://api.github.com/repos/google/agera/git/trees/55aaf29414bffa4bfb365bc146be888ff60fb73c"},"url":"https://api.github.com/repos/google/agera/git/commits/f7b24a991a740cd4cefae388838ac38809897fae","comment_count":0},"url":"https://api.github.com/repos/google/agera/commits/f7b24a991a740cd4cefae388838ac38809897fae","html_url":"https://github.com/google/agera/commit/f7b24a991a740cd4cefae388838ac38809897fae","comments_url":"https://api.github.com/repos/google/agera/commits/f7b24a991a740cd4cefae388838ac38809897fae/comments","author":{"login":"ernstsson","id":378389,"avatar_url":"https://avatars2.githubusercontent.com/u/378389?v=3","gravatar_id":"","url":"https://api.github.com/users/ernstsson","html_url":"https://github.com/ernstsson","followers_url":"https://api.github.com/users/ernstsson/followers","following_url":"https://api.github.com/users/ernstsson/following{/other_user}","gists_url":"https://api.github.com/users/ernstsson/gists{/gist_id}","starred_url":"https://api.github.com/users/ernstsson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ernstsson/subscriptions","organizations_url":"https://api.github.com/users/ernstsson/orgs","repos_url":"https://api.github.com/users/ernstsson/repos","events_url":"https://api.github.com/users/ernstsson/events{/privacy}","received_events_url":"https://api.github.com/users/ernstsson/received_events","type":"User","site_admin":false},"committer":{"login":"web-flow","id":19864447,"avatar_url":"https://avatars0.githubusercontent.com/u/19864447?v=3","gravatar_id":"","url":"https://api.github.com/users/web-flow","html_url":"https://github.com/web-flow","followers_url":"https://api.github.com/users/web-flow/followers","following_url":"https://api.github.com/users/web-flow/following{/other_user}","gists_url":"https://api.github.com/users/web-flow/gists{/gist_id}","starred_url":"https://api.github.com/users/web-flow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/web-flow/subscriptions","organizations_url":"https://api.github.com/users/web-flow/orgs","repos_url":"https://api.github.com/users/web-flow/repos","events_url":"https://api.github.com/users/web-flow/events{/privacy}","received_events_url":"https://api.github.com/users/web-flow/received_events","type":"User","site_admin":false},"parents":[{"sha":"d6736edeb5720036b44431925d7f10b45592da67","url":"https://api.github.com/repos/google/agera/commits/d6736edeb5720036b44431925d7f10b45592da67","html_url":"https://github.com/google/agera/commit/d6736edeb5720036b44431925d7f10b45592da67"}],"stats":{"total":33,"additions":29,"deletions":4},"files":[{"sha":"2284028890452995c32bb10b8e8568980e0a453e","filename":"agera/src/main/java/com/google/android/agera/FunctionCompiler.java","status":"modified","additions":26,"deletions":2,"changes":28,"blob_url":"https://github.com/google/agera/blob/f7b24a991a740cd4cefae388838ac38809897fae/agera/src/main/java/com/google/android/agera/FunctionCompiler.java","raw_url":"https://github.com/google/agera/raw/f7b24a991a740cd4cefae388838ac38809897fae/agera/src/main/java/com/google/android/agera/FunctionCompiler.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/FunctionCompiler.java?ref=f7b24a991a740cd4cefae388838ac38809897fae","patch":"@@ -32,6 +32,28 @@\n \n @SuppressWarnings({\"unchecked, rawtypes\"})\n final class FunctionCompiler implements FList, FItem {\n+  private static final ThreadLocal<FunctionCompiler> compilers = new ThreadLocal<>();\n+\n+  @NonNull\n+  static FunctionCompiler functionCompiler() {\n+    FunctionCompiler compiler = compilers.get();\n+    if (compiler == null) {\n+      compiler = new FunctionCompiler();\n+    } else {\n+      // Remove compiler from the ThreadLocal to prevent reuse in the middle of a compilation.\n+      // recycle(), called by compile(), will return the compiler here. ThreadLocal.set(null) keeps\n+      // the entry (with a null value) whereas remove() removes the entry; because we expect the\n+      // return of the compiler, don't use the heavier remove().\n+      compilers.set(null);\n+    }\n+    return compiler;\n+  }\n+\n+  private static void recycle(@NonNull final FunctionCompiler compiler) {\n+    compiler.functions.clear();\n+    compilers.set(compiler);\n+  }\n+\n   @NonNull\n   private final List<Function> functions;\n \n@@ -57,7 +79,9 @@ private Function createFunction() {\n     if (functions.isEmpty()) {\n       return NULL_OPERATOR;\n     }\n-    return new ChainFunction(functions.toArray(new Function[functions.size()]));\n+    final Function[] newFunctions = functions.toArray(new Function[functions.size()]);\n+    recycle(this);\n+    return new ChainFunction(newFunctions);\n   }\n \n   @NonNull\n@@ -76,7 +100,7 @@ public FItem apply(@NonNull final Function function) {\n \n   @NonNull\n   @Override\n-  public FList morph(@NonNull Function function) {\n+  public FList morph(@NonNull final Function function) {\n     addFunction(function);\n     return this;\n   }"},{"sha":"2158258f73dbcec98b3b9cb10433c1a404ff456a","filename":"agera/src/main/java/com/google/android/agera/Functions.java","status":"modified","additions":3,"deletions":2,"changes":5,"blob_url":"https://github.com/google/agera/blob/f7b24a991a740cd4cefae388838ac38809897fae/agera/src/main/java/com/google/android/agera/Functions.java","raw_url":"https://github.com/google/agera/raw/f7b24a991a740cd4cefae388838ac38809897fae/agera/src/main/java/com/google/android/agera/Functions.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/Functions.java?ref=f7b24a991a740cd4cefae388838ac38809897fae","patch":"@@ -17,6 +17,7 @@\n \n import static com.google.android.agera.Common.FAILED_RESULT;\n import static com.google.android.agera.Common.NULL_OPERATOR;\n+import static com.google.android.agera.FunctionCompiler.functionCompiler;\n import static com.google.android.agera.Preconditions.checkNotNull;\n \n import com.google.android.agera.Common.StaticProducer;\n@@ -70,7 +71,7 @@\n   @NonNull\n   @SuppressWarnings({\"unchecked\", \"UnusedParameters\"})\n   public static <F> FItem<F, F> functionFrom(@Nullable Class<F> from) {\n-    return new FunctionCompiler();\n+    return functionCompiler();\n   }\n \n   /**\n@@ -82,7 +83,7 @@\n   @SuppressWarnings({\"unchecked\", \"UnusedParameters\"})\n   public static <F> FList<F, List<F>, List<F>> functionFromListOf(\n       @Nullable final Class<F> from) {\n-    return new FunctionCompiler();\n+    return functionCompiler();\n   }\n \n   /**"}]}