{"sha":"46db3cee8d04141d9ede41829976ce28381e20ca","commit":{"author":{"name":"Magnus Ernstsson","email":"magnus@ernstsson.net","date":"2016-06-01T15:22:32Z"},"committer":{"name":"Magnus Ernstsson","email":"magnus@ernstsson.net","date":"2016-06-01T15:22:32Z"},"message":"Fixed some problems in update scheduling (#69)","tree":{"sha":"1d51aeee8aa1962711dd11a37987ac3ba6d8cea8","url":"https://api.github.com/repos/google/agera/git/trees/1d51aeee8aa1962711dd11a37987ac3ba6d8cea8"},"url":"https://api.github.com/repos/google/agera/git/commits/46db3cee8d04141d9ede41829976ce28381e20ca","comment_count":0},"url":"https://api.github.com/repos/google/agera/commits/46db3cee8d04141d9ede41829976ce28381e20ca","html_url":"https://github.com/google/agera/commit/46db3cee8d04141d9ede41829976ce28381e20ca","comments_url":"https://api.github.com/repos/google/agera/commits/46db3cee8d04141d9ede41829976ce28381e20ca/comments","author":{"login":"ernstsson","id":378389,"avatar_url":"https://avatars2.githubusercontent.com/u/378389?v=3","gravatar_id":"","url":"https://api.github.com/users/ernstsson","html_url":"https://github.com/ernstsson","followers_url":"https://api.github.com/users/ernstsson/followers","following_url":"https://api.github.com/users/ernstsson/following{/other_user}","gists_url":"https://api.github.com/users/ernstsson/gists{/gist_id}","starred_url":"https://api.github.com/users/ernstsson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ernstsson/subscriptions","organizations_url":"https://api.github.com/users/ernstsson/orgs","repos_url":"https://api.github.com/users/ernstsson/repos","events_url":"https://api.github.com/users/ernstsson/events{/privacy}","received_events_url":"https://api.github.com/users/ernstsson/received_events","type":"User","site_admin":false},"committer":{"login":"ernstsson","id":378389,"avatar_url":"https://avatars2.githubusercontent.com/u/378389?v=3","gravatar_id":"","url":"https://api.github.com/users/ernstsson","html_url":"https://github.com/ernstsson","followers_url":"https://api.github.com/users/ernstsson/followers","following_url":"https://api.github.com/users/ernstsson/following{/other_user}","gists_url":"https://api.github.com/users/ernstsson/gists{/gist_id}","starred_url":"https://api.github.com/users/ernstsson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ernstsson/subscriptions","organizations_url":"https://api.github.com/users/ernstsson/orgs","repos_url":"https://api.github.com/users/ernstsson/repos","events_url":"https://api.github.com/users/ernstsson/events{/privacy}","received_events_url":"https://api.github.com/users/ernstsson/received_events","type":"User","site_admin":false},"parents":[{"sha":"b1f540360b166f3ba3f2accdb42f15f36b5ed71f","url":"https://api.github.com/repos/google/agera/commits/b1f540360b166f3ba3f2accdb42f15f36b5ed71f","html_url":"https://github.com/google/agera/commit/b1f540360b166f3ba3f2accdb42f15f36b5ed71f"}],"stats":{"total":35,"additions":10,"deletions":25},"files":[{"sha":"e3ab3ad047e228d0803d1147d63e140d928873f8","filename":"agera/src/main/java/com/google/android/agera/IdentityMultimap.java","status":"renamed","additions":3,"deletions":12,"changes":15,"blob_url":"https://github.com/google/agera/blob/46db3cee8d04141d9ede41829976ce28381e20ca/agera/src/main/java/com/google/android/agera/IdentityMultimap.java","raw_url":"https://github.com/google/agera/raw/46db3cee8d04141d9ede41829976ce28381e20ca/agera/src/main/java/com/google/android/agera/IdentityMultimap.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/IdentityMultimap.java?ref=46db3cee8d04141d9ede41829976ce28381e20ca","patch":"@@ -4,21 +4,12 @@\n \n import java.util.Arrays;\n \n-final class IdentityMultiMap<K, V> {\n+final class IdentityMultimap<K, V> {\n   @NonNull\n   private static final Object[] NO_KEY_VALUES = new Object[0];\n \n   @NonNull\n-  private Object[] keysValues;\n-\n-  IdentityMultiMap() {\n-    this.keysValues = NO_KEY_VALUES;\n-  }\n-\n-  @NonNull\n-  Object[] getKeysValues() {\n-    return keysValues;\n-  }\n+  private Object[] keysValues = NO_KEY_VALUES;\n \n   synchronized boolean addKeyValuePair(@NonNull final K key, @NonNull final V value) {\n     int size = 0;\n@@ -50,7 +41,7 @@ synchronized boolean addKeyValuePair(@NonNull final K key, @NonNull final V valu\n \n   synchronized void removeKeyValuePair(@NonNull final K key, @NonNull final V value) {\n     for (int index = 0; index < keysValues.length; index += 2) {\n-      if (keysValues[index] == keysValues && keysValues[index + 1] == value) {\n+      if (keysValues[index] == key && keysValues[index + 1] == value) {\n         keysValues[index] = null;\n         keysValues[index + 1] = null;\n       }","previous_filename":"agera/src/main/java/com/google/android/agera/IdentityMultiMap.java"},{"sha":"b86d92fda2ace248a6d7e1a069a0ac58f8f536a1","filename":"agera/src/main/java/com/google/android/agera/WorkerHandler.java","status":"modified","additions":7,"deletions":6,"changes":13,"blob_url":"https://github.com/google/agera/blob/46db3cee8d04141d9ede41829976ce28381e20ca/agera/src/main/java/com/google/android/agera/WorkerHandler.java","raw_url":"https://github.com/google/agera/raw/46db3cee8d04141d9ede41829976ce28381e20ca/agera/src/main/java/com/google/android/agera/WorkerHandler.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/main/java/com/google/android/agera/WorkerHandler.java?ref=46db3cee8d04141d9ede41829976ce28381e20ca","patch":"@@ -18,7 +18,7 @@\n   static final int MSG_CALL_ACKNOWLEDGE_CANCEL = 5;\n   private static final ThreadLocal<WeakReference<WorkerHandler>> handlers = new ThreadLocal<>();\n   @NonNull\n-  private final IdentityMultiMap<Updatable, Object> updatableObservable;\n+  private final IdentityMultimap<Updatable, Object> scheduledUpdatables;\n \n   @NonNull\n   static WorkerHandler workerHandler() {\n@@ -32,16 +32,16 @@ static WorkerHandler workerHandler() {\n   }\n \n   private WorkerHandler() {\n-    this.updatableObservable = new IdentityMultiMap<>();\n+    this.scheduledUpdatables = new IdentityMultimap<>();\n   }\n \n   synchronized void removeUpdatable(@NonNull final Updatable updatable,\n       @NonNull final Object token) {\n-    updatableObservable.removeKeyValuePair(updatable, token);\n+    scheduledUpdatables.removeKeyValuePair(updatable, token);\n   }\n \n   synchronized void update(@NonNull final Updatable updatable, @NonNull final Object token) {\n-    if (updatableObservable.addKeyValuePair(updatable, token)) {\n+    if (scheduledUpdatables.addKeyValuePair(updatable, token)) {\n       obtainMessage(WorkerHandler.MSG_CALL_UPDATABLE, updatable).sendToTarget();\n     }\n   }\n@@ -60,8 +60,9 @@ public void handleMessage(final Message message) {\n         break;\n       case MSG_CALL_UPDATABLE:\n         final Updatable updatable = (Updatable) message.obj;\n-        updatableObservable.removeKey(updatable);\n-        updatable.update();\n+        if (scheduledUpdatables.removeKey(updatable)) {\n+          updatable.update();\n+        }\n         break;\n       case MSG_CALL_MAYBE_START_FLOW:\n         ((CompiledRepository) message.obj).maybeStartFlow();"},{"sha":"e804751e8eea9ab77e31cba73ed78a42ca1f23d8","filename":"agera/src/test/java/com/google/android/agera/ObservablesTest.java","status":"modified","additions":0,"deletions":7,"changes":7,"blob_url":"https://github.com/google/agera/blob/46db3cee8d04141d9ede41829976ce28381e20ca/agera/src/test/java/com/google/android/agera/ObservablesTest.java","raw_url":"https://github.com/google/agera/raw/46db3cee8d04141d9ede41829976ce28381e20ca/agera/src/test/java/com/google/android/agera/ObservablesTest.java","contents_url":"https://api.github.com/repos/google/agera/contents/agera/src/test/java/com/google/android/agera/ObservablesTest.java?ref=46db3cee8d04141d9ede41829976ce28381e20ca","patch":"@@ -343,13 +343,6 @@ public void shouldHandleManyObservables() {\n   }\n \n   @Test\n-  public void shouldCallMessageObjUpdateForMsgCallUpdatableMessage() {\n-    workerHandler().obtainMessage(WorkerHandler.MSG_CALL_UPDATABLE, updatable).sendToTarget();\n-\n-    assertThat(updatable, wasUpdated());\n-  }\n-\n-  @Test\n   public void shouldIgnoreUnknownMessage() {\n     workerHandler().obtainMessage(-1).sendToTarget();\n   }"}]}